"use strict";!function(){var e=Number.isInteger,t=window.Bliss,i=window.Mavo,s=window.firebase;i.Backend.register(t.Class({extends:i.Backend,id:"Firebase",constructor:function e(t){function i(e){return e?e.split(/\s+/):""===e?[]:void 0}var a=this,n=this.mavo.id||"mavo",r={},o=/^https:\/\/.*\.firebaseio\.com$/.test(t);if(o){if(r={apiKey:this.mavo.element.getAttribute("mv-firebase-api-key"),authDomain:this.mavo.element.getAttribute("mv-firebase-auth-domain"),databaseURL:t,storageBucket:this.mavo.element.getAttribute("mv-firebase-storage-bucket")},!r.apiKey)return this.mavo.error("Firebase: mv-firebase-api-key attribute missing");this.app=s.apps.length?s.initializeApp(r,"app"+s.apps.length):s.initializeApp(r)}else{if(r=s.default.app().options,!r.apiKey)return this.mavo.error("Firebase: apiKey missing from config");this.app=s.default}this.statusChangesCallbacks=[];var u=this.mavo.element.getAttribute("mv-unauthenticated-permissions"),h=this.mavo.element.getAttribute("mv-authenticated-permissions"),f=i(h)||["read","edit","add","delete","save","logout"],c=i(u);if(c){if(!r.authDomain&&c.includes("login"))return o?this.mavo.error("Firebase: authDomain missing from config (needed if permission 'login' is specified)"):this.mavo.error("Firebase: firebase-auth-domain attribute missing (needed if permission 'login' is specified)")}else c=r.authDomain?["read","login"]:["read"];this.defaultPermissions={authenticated:f,unauthenticated:c},this.permissions.on(this.defaultPermissions.unauthenticated),this.db=this.app.database().ref(n),r.storageBucket&&(this.storage=this.app.storage().ref(n),this.upload=function(e){var t=this.storage.child(e.name+"-"+Date.now());return t.put(e).then(function(){return t.getDownloadURL()})}),this.app.auth().onAuthStateChanged(function(e){e&&(a.permissions.off(a.defaultPermissions.unauthenticated).on(a.defaultPermissions.authenticated),a.user={username:e.email,name:e.displayName,avatar:e.photoURL})},function(e){a.mavo.error("Firebase: "+e.message)});var v=this.mavo.element.getAttribute("mv-server-push");null!==v&&"false"!==v&&this.setListenForChanges(!0)},onStatusChange:function e(t){var i=this;this.statusChangesCallbacks.push(t),this.listeningOnStatus||(this.listeningOnStatus=!0,this.app.database().ref(".info/connected").on("value",function(e){i.statusChangesCallbacks.forEach(function(t){return t(e.val())})}))},setListenForChanges:function e(t){var i=this;t?!this.listeningForChanges&&this.db.on("value",function(e){var t=e.val();1!==i.compareDocRevs({_rev:i.rev},t)||(i.rev=t._rev,i.onNewData(t))}):this.db.off(),this.listeningForChanges=t},onNewData:function e(t){return this.mavo.render(t)},load:function e(){var t=this;return this.db.once("value").then(function(e){var i=e.val();return i?(t.rev=i._rev||1,i):(t.rev=1,{})})},store:function e(t){var i=this;return Promise.resolve().then(function(){if(i.storeData=t,i.mavo.unsavedChanges&&!i.storing)return i.storing=!0,i.put().then(function(){i.storing=!1})})},put:function t(i){var s=this;return i=this.storeData||i,delete this.storeData,this.db.transaction(function(t){return s.rev=t&&e(t._rev)?t._rev+1:1,Object.assign(i,{_rev:s.rev})}).then(function(){if(s.storeData)return s.put()})},login:function e(){var t=this;return this.ready.then(function(){if(!t.user){var e=new s.auth.GoogleAuthProvider;return t.app.auth().signInWithPopup(e).catch(function(e){return t.mavo.error("Firebase: "+e.message),Promise.reject(e)})}})},logout:function e(){var t=this;return this.app.auth().signOut().then(function(){t.permissions.off(t.defaultPermissions.authenticated).on(t.defaultPermissions.unauthenticated)}).catch(function(e){t.mavo.error("Firebase: "+e.message)})},compareDocRevs:function t(i,s){return i&&e(i._rev)?s&&e(s._rev)?i._rev===s._rev?0:i._rev<s._rev?1:-1:-1:1},static:{test:function e(t){return/^(firebase|https:\/\/.*\.firebaseio\.com)$/.test(t)}}}))}();